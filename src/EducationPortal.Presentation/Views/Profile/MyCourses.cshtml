@model EducationPortal.Presentation.ViewModels.Profile.MyCoursesViewModel
@{
    ViewData["Title"] = "My Courses";
    string activeTab = (Context.Request.Query["tab"].ToString() ?? "").ToLowerInvariant();
    if (string.IsNullOrWhiteSpace(activeTab)) activeTab = "inprogress";
    string Active(string key) => activeTab == key ? "active" : "";
}

<h2 class="mb-3">My Courses</h2>

<ul class="nav nav-pills mb-3">
    <li class="nav-item">
        <a class="nav-link @Active("inprogress")" href="@Url.Action("MyCourses", "Profile", new { tab = "inprogress" })">In Progress</a>
    </li>
    <li class="nav-item">
        <a class="nav-link @Active("completed")" href="@Url.Action("MyCourses", "Profile", new { tab = "completed" })">Completed</a>
    </li>
</ul>

@if (activeTab == "completed")
{
    if (Model.Completed.Count == 0)
    {
        <p class="text-muted">No completed courses yet.</p>
    }
    else
    {
        <ul class="list-group">
            @foreach (var item in Model.Completed)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>@item.CourseName</span>
                    <span class="badge bg-success">@item.ProgressPercent %</span>
                </li>
            }
        </ul>
    }
}
else
{
    if (Model.InProgressDetailed.Count == 0)
    {
        <p class="text-muted">No courses in progress.</p>
    }
    else
    {
        <div class="accordion" id="inProgressAccordion">
            @for (int i = 0; i < Model.InProgressDetailed.Count; i++)
            {
                var course = Model.InProgressDetailed[i];
                var collapseId = $"collapse_{course.CourseId}";
                <div class="accordion-item mb-2">
                    <h2 class="accordion-header" id="heading_@course.CourseId">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#@collapseId">
                            <div class="w-100 d-flex justify-content-between">
                                <div>@course.CourseName</div>
                                <div><span class="badge bg-primary">@course.ProgressPercent %</span></div>
                            </div>
                        </button>
                    </h2>
                    <div id="@collapseId" class="accordion-collapse collapse" data-bs-parent="#inProgressAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <form asp-controller="Enrollments" asp-action="CompleteCourse" method="post" asp-antiforgery="true">
                                    <input type="hidden" name="courseId" value="@course.CourseId" />
                                    <button type="submit" class="btn btn-sm btn-success">Complete course</button>
                                </form>
                            </div>

                            @if (!course.Materials.Any())
                            {
                                <p class="text-muted mb-0">No materials in this course.</p>
                            }
                            else
                            {
                                <ul class="list-group">
                                    @foreach (var material in course.Materials)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>@material.Title</span>
                                            <span>
                                                @if (material.IsCompleted)
                                                {
                                                    <span class="badge bg-secondary">Completed</span>
                                                }
                                                else
                                                {
                                                    <form class="d-inline"
                                                          asp-controller="Enrollments" asp-action="MarkMaterialComplete"
                                                          method="post" asp-antiforgery="true">
                                                        <input type="hidden" name="materialId" value="@material.MaterialId" />
                                                        <button type="submit" class="btn btn-sm btn-outline-primary">Complete material</button>
                                                    </form>
                                                }
                                            </span>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}

<div class="mt-3">
    <a class="btn btn-outline-secondary" asp-action="MyProfile">Back to Profile</a>
</div>